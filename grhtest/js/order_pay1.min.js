$(document).ready(function(){var pay_style='1';var isCanPay="";var verify_code="";var bankCard='';var openId="";var preOrderCode='';var smsCode,mobile,sign,source;mobile=common.user_data().mobile;if(sessionStorage.orderCode){preOrderCode=sessionStorage.orderCode;source="preOrderCode"+preOrderCode;sign=md5(source+"key"+common.secretKey()).toUpperCase();getOrderInfo(preOrderCode,sign,source)};function get_weixin_code(){if(sessionStorage.weixin){return JSON.parse(sessionStorage.weixin)}else{return 0}};function getOrderInfo(orderCode,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:'pre_order_details',orderCode:orderCode,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=="100000"){isCanPay=data.data.isCanPay;orderPayShow(data)}},error:function(data){common.prompt(str)}})};function orderPayShow(data){headerShow(data);$(".pay_style_month").show();$(".pay_style_month .pay_style_item").addClass("bg_select");if(isCanPay){$('.pay_style_msg1').show();$('.go_pay').css("background","#fe7831").show()}else{$('.pay_style_msg').show();$('.go_pay').css("background","#b2b2b2").show()}if(get_weixin_code().fromWX=='1'){openId=get_weixin_code().openId;$(".pay_style_line").show();$('.pay_style_line .pay_style_item').eq(1).hide();$('.go_pay').css("background","#fe7831").show()}else{$('.pay_style_line .pay_style_item').eq(0).hide();$(".pay_style_line").show()}};function headerShow(data){$(".orderList_intro").html("订单已提交！");$(".orderList_details ul li").eq(0).html("预购商品:<span>"+data.data.goodsInfo.goodsName+"</span>");$(".orderList_details ul li").eq(1).html("订单号:<span>"+data.data.orderCode+"</span>");$(".orderList_details ul li").eq(2).html("预购金额:<span class='font_color'>￥"+data.data.frontMoney+"</span>")};$(".pay_style_box .pay_style_item").on("click",function(){$(".pay_style_item").removeClass("bg_select");$(this).addClass("bg_select");if($(this).find("p").html()=="月卡支付"){pay_style="1";if(isCanPay){$('.pay_style_msg1').show();$('.go_pay').css("background","#fe7831").show()}else{$('.pay_style_msg').show();$('.go_pay').css("background","#b2b2b2").show()}$(".pay_style_input").hide()}else if($(this).find("p").html()=="微信支付"){pay_style="2";$('.pay_style_msg').hide();$('.pay_style_msg1').hide();$(".pay_style_input").hide();$('.go_pay').css("background","#fe7831").show();}else if($(this).find("p").html()=="银行卡支付"){pay_style="3";$('.pay_style_msg').hide();$('.pay_style_msg1').hide();$(".pay_style_input").show();$('.go_pay').css("background","#fe7831").show();}else if($(this).find("p").html()=="支付宝支付"){pay_style="4";$('.pay_style_msg').hide();$('.pay_style_msg1').hide();$(".pay_style_input").hide();$('.go_pay').css("background","#fe7831").show()}});$(".go_pay").on("click",function(){if($(this).css("background-color")=="rgb(254, 120, 49)"){if(pay_style=="1"){smsCode=$("#verify_code1").val();if($("#verify_code1").val()==""){common.prompt("请输入验证码")}else if($("#verify_code1").val()==verify_code){true_pay_month(preOrderCode,smsCode,mobile,sign,source)}else{common.prompt("验证码输入有误！")}}else if(pay_style=="2"){ture_pay_weixin(preOrderCode,openId,sign,source)}else if(pay_style=="3"){if($("#pay_style_card").val()==""){common.prompt("请输入银行卡号")}else{bankCard=$("#pay_style_card").val();ture_pay_yinghangka(preOrderCode,bankCard,sign,source)}}else if(pay_style=="4"){true_pay_zfb(preOrderCode,sign,source)}}});function true_pay_month(orderCode,smsCode,mobile,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:'pre_order_month_pay',orderCode:orderCode,smsCode:smsCode,mobile:mobile,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=="100000"){window.location.href="pay_result.html"}else{common.prompt(data.statusStr)}},error:function(data){common.prompt(data.statusStr)}})};function ture_pay_yinghangka(orderCode,bankCard,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:'pre_order_ll_pay',orderCode:orderCode,bankCard:bankCard,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=='100000'){var str=JSON.stringify(data.data);$('#input1').attr('value',str);$('#form1').submit()}else{common.prompt(data.statusStr)}},error:function(data){common.prompt(data.statusStr)}})};function ture_pay_weixin(orderCode,openId,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:"pre_order_wx_pay",orderCode:orderCode,url:common.http,openId:openId,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=='100200'){alert("微信提交订单异常，请重新操作!")}else if(data.statusCode=='100000'){var result=data.data;var prepayId=result.prepayId;var nonceStr=result.nonceStr;var timeStamp=result.timeStamp;var packages=result.package;var paySign=result.paySign;var appId=result.appId;var signType=result.signType;var configSign=result.configSign;var timestamp=result.timestamp;var noncestr=result.noncestr;wx.config({debug:false,appId:appId,timestamp:timestamp,nonceStr:noncestr,signature:configSign,jsApiList:["chooseWXPay"]});wx.ready(function(){wx.chooseWXPay({timestamp:timeStamp,nonceStr:nonceStr,package:packages,signType:signType,paySign:paySign,success:function(res){window.location.href='PreOrder_management.html'}})})}},error:function(data){alert("支付插件升级中。。。")}})};function true_pay_zfb(preOrderCode,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:'pre_order_ali_pay',orderCode:preOrderCode,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=='100000'){var str=data.data;var html="";for(var i in str){html+='<input type="hidden" name="'+i+'" id="" value="'+str[i]+'" />'}$("#form2").append(html);$("#form2").submit()}else{common.prompt(data.statusStr)}},error:function(data){common.prompt(data.statusStr)}})};$('#get_verify_code').on('click',function(){var mobile=common.user_data().mobile;i=59;$("#verify_code1").removeAttr("disabled");$("#get_verify_code").css("display",'none');$("#time").show().html('(60s后重试)');login_verify_code(mobile);verify_code_time()});function login_verify_code(mobile){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:'send_sms',mobile:mobile,type:'3'},success:function(data){if(data.statusCode=="100000"){verify_code=data.data}}})};function verify_code_time(){var id=setInterval(function(){if(i==0){$("#time").css("display","none");$("#get_verify_code").css("display","block");$("#get_verify_code").html('重新获取');clearInterval(id)}else{$("#time").html("("+i+"s后可重试)");$("#time").css({"color":"#f76a10","background":"none"})}i-=1},1000)};$(".header_left").on("click",function(){window.location.href='PreOrder_management.html'})});
define(function(require, exports, module){require('jquery'); var common = require('../lib/common'); require('mdData'); require('LArea'); require('weixin');var userId=common.user_data().cuserInfoid;var source="userId"+userId;var sign=md5(source+"key"+common.secretKey()).toUpperCase();var tokenId=common.tokenId();var pay_style="0";var moneyReg=/^[1-9]\d*$/;var cardReg=common.bankCardReg;var payMoney,bankCard;var openId="";function get_weixin_code(){if(sessionStorage.weixin){return JSON.parse(sessionStorage.weixin)}else{return 0}};if(get_weixin_code().fromWX=='1'){openId=get_weixin_code().openId;$(".month_card_recharge_item").show();$(".month_card_recharge_item").eq(0).find(".month_card_recharge_item_tit").css("background","url(../img/bg_num_a.png) no-repeat right center");$(".month_card_recharge_item").eq(0).find("dl").show();$(".month_card_recharge_item").eq(1).hide();pay_style="0"}else{$(".month_card_recharge_item").eq(1).show().find(".month_card_recharge_item_tit").css("background","url(../img/bg_num_a.png) no-repeat right center");$(".month_card_recharge_item").eq(1).find("dl").show();$(".month_card_recharge_item").eq(2).show();pay_style="1"};$(".month_card_recharge_item").on("click",function(){pay_style=$(this).index();$(this).siblings().find("dl").hide();$(this).siblings().find(".month_card_recharge_item_tit").css("background","url(../img/bg_num_b.png) no-repeat right center");$(this).find("dl").show();$(this).find(".month_card_recharge_item_tit").css("background","url(../img/bg_num_a.png) no-repeat right center")});function get_month_money(userId,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:'user_month_card',userId:userId,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode="100000"){if(data.data){$(".month_sign2").html(data.data.systemMoney)}else{$(".month_sign2").html("0")}}else{}},error:function(data){common.prompt(data.statusStr)}})};get_month_money(userId,sign,source);$(".rechange_now").on("click",function(){if(pay_style=="0"){payMoney=$('#wx_rechange').val();payMoney=Number(payMoney);if(payMoney==""){common.prompt("请输入充值金额");}else if(!Number.isNaN(payMoney)&&payMoney>0){wx_rechange(payMoney,openId,userId,sign,source)}else{common.prompt("充值金额只能为数字且大于0")}}else if(pay_style=="1"){payMoney=$('#zfb_rechange').val();payMoney=Number(payMoney);if(payMoney==""){common.prompt("请输入充值金额");}else if(!Number.isNaN(payMoney)&&payMoney>0){source="payMoney"+payMoney+"-userId"+userId;sign=md5(source+"key"+common.secretKey()).toUpperCase();zfb_rechange(payMoney,userId,sign,source)}else{common.prompt("充值金额只能为数字且大于0")}}else if(pay_style=="2"){payMoney=$('#quick_rechange').val();payMoney=Number(payMoney);bankCard=$("#quick_idCard").val();if(payMoney==""){common.prompt("请输入充值金额")}else if(Number.isNaN(payMoney)||payMoney<=0){common.prompt("充值金额只能为数字且大于0")}else if(!cardReg.test(bankCard)){common.prompt("卡号输入有误")}else{yhk_rechange(payMoney,bankCard,userId,sign,source)}}});function wx_rechange(payMoney,openId,userId,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:"month_card_wx_pay",payMoney:payMoney,url:common.http,openId:openId,userId:userId,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=='100200'){alert("微信提交订单异常，请重新操作!")}else if(data.statusCode=='100000'){var result=data.data;var prepayId=result.prepayId;var nonceStr=result.nonceStr;var timeStamp=result.timeStamp;var packages=result.package;var paySign=result.paySign;var appId=result.appId;var signType=result.signType;var configSign=result.configSign;var timestamp=result.timestamp;var noncestr=result.noncestr;wx.config({debug:false,appId:appId,timestamp:timestamp,nonceStr:noncestr,signature:configSign,jsApiList:["chooseWXPay"]});wx.ready(function(){wx.chooseWXPay({timestamp:timeStamp,nonceStr:nonceStr,package:packages,signType:signType,paySign:paySign,success:function(res){window.location.href='month_recharge.html'}})})}},error:function(data){alert("支付插件升级中。。。")}})};function zfb_rechange(payMoney,userId,sign,source){$.ajax({url:common.http,type:"post",dataType:"jsonp",data:{method:'month_card_ali_pay',payMoney:payMoney,userId:userId,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=='100000'){var str=data.data;var html="";for(var i in str){html+='<input type="hidden" name="'+i+'" id="" value="'+str[i]+'" />'};$("#form2").append(html);$("#form2").submit()}else{common.prompt(data.statusStr)}},error:function(data){common.prompt(data.statusStr)}})};function yhk_rechange(payMoney,bankCard,userId,sign,source){$.ajax({url:common.http,dataType:'jsonp',data:{method:'month_card_ll_pay',payMoney:payMoney,bankCard:bankCard,userId:userId,tokenId:common.tokenId(),sign:sign,source:source},success:function(data){if(data.statusCode=="100000"){var str=JSON.stringify(data.data);$('#input1').attr('value',str);$('#form1').submit()}},error:function(data){}})};$('.month_pay_deal').on('click',function(){window.location.href='month_service.html'});$('.header_left').on('click',function(){window.location.href='my.html'})});